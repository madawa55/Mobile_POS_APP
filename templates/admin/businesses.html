{% extends "base.html" %}

{% block title %}Business Management - Admin{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h2><i class="fas fa-building me-2"></i>Business Management</h2>
    <div class="text-muted">
        {{ businesses|length }} Total Businesses
    </div>
</div>

<div class="row">
    {% for business in businesses %}
    <div class="col-md-6 mb-4">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">{{ business.name }}</h5>
                <span class="badge bg-primary">ID: {{ business.id }}</span>
            </div>
            <div class="card-body">
                <div class="row mb-3">
                    <div class="col-sm-6">
                        <strong>Email:</strong><br>
                        <span class="text-muted">{{ business.email or 'Not provided' }}</span>
                    </div>
                    <div class="col-sm-6">
                        <strong>Phone:</strong><br>
                        <span class="text-muted">{{ business.phone or 'Not provided' }}</span>
                    </div>
                </div>

                <div class="mb-3">
                    <strong>Address:</strong><br>
                    <span class="text-muted">{{ business.address or 'Not provided' }}</span>
                </div>

                <div class="mb-3">
                    <strong>Registered:</strong>
                    <span class="text-muted">{{ business.created_at.strftime('%B %d, %Y') }}</span>
                </div>

                {% set features = business_features.get(business.id, []) %}
                {% if features %}
                <div class="mb-3">
                    <strong>Active Features:</strong>
                    <div class="mt-2">
                        {% for business_feature, feature in features %}
                        {% if business_feature.is_active %}
                        <span class="badge bg-success me-1 mb-1">
                            <i class="fas fa-check me-1"></i>{{ feature.name }}
                        </span>
                        {% endif %}
                        {% endfor %}

                        {% set inactive_features = [] %}
                        {% for business_feature, feature in features %}
                            {% if not business_feature.is_active %}
                                {{ inactive_features.append((business_feature, feature)) or '' }}
                            {% endif %}
                        {% endfor %}

                        {% if inactive_features %}
                        <details class="mt-2">
                            <summary class="text-muted small">Show inactive features</summary>
                            {% for business_feature, feature in inactive_features %}
                            <span class="badge bg-secondary me-1 mb-1">
                                <i class="fas fa-times me-1"></i>{{ feature.name }}
                            </span>
                            {% endfor %}
                        </details>
                        {% endif %}
                    </div>
                </div>
                {% else %}
                <div class="mb-3">
                    <span class="text-muted">No features activated</span>
                </div>
                {% endif %}

                <div class="d-flex gap-2">
                    <a href="{{ url_for('business_features_detail', business_id=business.id) }}"
                       class="btn btn-sm btn-outline-primary">
                        <i class="fas fa-cog me-1"></i>Features
                    </a>
                    <a href="{{ url_for('generate_activation_key') }}?business_id={{ business.id }}"
                       class="btn btn-sm btn-outline-success">
                        <i class="fas fa-key me-1"></i>Generate Key
                    </a>
                    <a href="#" class="btn btn-sm btn-outline-info" data-bs-toggle="modal"
                       data-bs-target="#businessModal{{ business.id }}">
                        <i class="fas fa-info-circle me-1"></i>Details
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- Business Details Modal -->
    <div class="modal fade" id="businessModal{{ business.id }}" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">{{ business.name }} - Business Details</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-6">
                            <h6>Business Information</h6>
                            <table class="table table-sm">
                                <tr><td><strong>Name:</strong></td><td>{{ business.name }}</td></tr>
                                <tr><td><strong>Email:</strong></td><td>{{ business.email or 'Not provided' }}</td></tr>
                                <tr><td><strong>Phone:</strong></td><td>{{ business.phone or 'Not provided' }}</td></tr>
                                <tr><td><strong>Address:</strong></td><td>{{ business.address or 'Not provided' }}</td></tr>
                                <tr><td><strong>Registered:</strong></td><td>{{ business.created_at.strftime('%B %d, %Y at %H:%M') }}</td></tr>
                            </table>
                        </div>
                        <div class="col-md-6">
                            <h6>Feature Status</h6>
                            {% if features %}
                            <table class="table table-sm">
                                {% for business_feature, feature in features %}
                                <tr>
                                    <td>{{ feature.name }}</td>
                                    <td>
                                        {% if business_feature.is_active %}
                                        <span class="badge bg-success">Active</span>
                                        {% else %}
                                        <span class="badge bg-secondary">Inactive</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if business_feature.activated_at %}
                                        <small class="text-muted">{{ business_feature.activated_at.strftime('%m/%d/%Y') }}</small>
                                        {% else %}
                                        <small class="text-muted">-</small>
                                        {% endif %}
                                    </td>
                                </tr>
                                {% endfor %}
                            </table>
                            {% else %}
                            <p class="text-muted">No features activated</p>
                            {% endif %}
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <a href="{{ url_for('generate_activation_key') }}?business_id={{ business.id }}"
                       class="btn btn-success">Generate Activation Key</a>
                </div>
            </div>
        </div>
    </div>
    {% else %}
    <div class="col-12">
        <div class="card">
            <div class="card-body text-center text-muted">
                <i class="fas fa-building fa-3x mb-3"></i>
                <h5>No Businesses Found</h5>
                <p>No businesses have been registered in the system yet.</p>
            </div>
        </div>
    </div>
    {% endfor %}
</div>
{% endblock %}