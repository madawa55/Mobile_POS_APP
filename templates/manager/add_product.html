{% extends "base.html" %}

{% block title %}Add Product{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h2><i class="fas fa-plus me-2"></i>Add New Product</h2>
    <a href="{{ url_for('product_management') }}" class="btn btn-outline-secondary">
        <i class="fas fa-arrow-left me-1"></i>Back to Products
    </a>
</div>

<div class="row">
    <div class="col-lg-8">
        <div class="card">
            <div class="card-header">
                <h5><i class="fas fa-info-circle me-2"></i>Product Information</h5>
            </div>
            <div class="card-body">
                <form method="POST" enctype="multipart/form-data" id="productForm">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="name" class="form-label">Product Name *</label>
                                <input type="text" class="form-control" id="name" name="name" required>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="barcode" class="form-label">
                                    Barcode *
                                    <button type="button" class="btn btn-sm btn-outline-primary ms-2" onclick="generateBarcode()">
                                        <i class="fas fa-magic"></i> Generate
                                    </button>
                                </label>
                                <input type="text" class="form-control" id="barcode" name="barcode" required>
                                <div class="form-text">Scan or enter product barcode</div>
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="price" class="form-label">Selling Price * ($)</label>
                                <input type="number" step="0.01" class="form-control" id="price" name="price" required>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="cost" class="form-label">Cost Price ($)</label>
                                <input type="number" step="0.01" class="form-control" id="cost" name="cost">
                                <div class="form-text">Leave empty if unknown</div>
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="stock_quantity" class="form-label">Initial Stock Quantity</label>
                                <input type="number" class="form-control" id="stock_quantity" name="stock_quantity" value="0">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="min_stock_level" class="form-label">Minimum Stock Level</label>
                                <input type="number" class="form-control" id="min_stock_level" name="min_stock_level" value="5">
                                <div class="form-text">Alert when stock reaches this level</div>
                            </div>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label for="category_id" class="form-label">Category</label>
                        <select class="form-select" id="category_id" name="category_id">
                            <option value="">Select Category (Optional)</option>
                            {% for category in categories %}
                            <option value="{{ category.id }}">{{ category.name }}</option>
                            {% endfor %}
                        </select>
                    </div>

                    <div class="mb-3">
                        <label for="image" class="form-label">Product Image</label>
                        <input type="file" class="form-control" id="image" name="image" accept="image/*">
                        <div class="form-text">Upload a product image (JPG, PNG, GIF)</div>
                    </div>

                    <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                        <button type="button" class="btn btn-outline-secondary me-md-2" onclick="resetForm()">
                            <i class="fas fa-undo me-1"></i>Reset Form
                        </button>
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-save me-1"></i>Save Product
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <div class="col-lg-4">
        <!-- Product Preview -->
        <div class="card mb-4">
            <div class="card-header">
                <h6><i class="fas fa-eye me-2"></i>Product Preview</h6>
            </div>
            <div class="card-body">
                <div class="product-preview" id="productPreview">
                    <div class="text-center mb-3">
                        <div id="previewImage" class="preview-image bg-light d-flex align-items-center justify-content-center"
                             style="width: 100%; height: 150px; border-radius: 8px;">
                            <i class="fas fa-image fa-2x text-muted"></i>
                        </div>
                    </div>
                    <h6 id="previewName" class="text-muted">Product Name</h6>
                    <p class="mb-1">
                        <strong class="text-success" id="previewPrice">$0.00</strong>
                        <span class="text-muted ms-2" id="previewCost">(Cost: $0.00)</span>
                    </p>
                    <p class="mb-1">
                        <small class="text-muted" id="previewBarcode">Barcode: Not set</small>
                    </p>
                    <p class="mb-0">
                        <span class="badge bg-secondary" id="previewStock">Stock: 0</span>
                    </p>
                </div>
            </div>
        </div>

        <!-- Barcode Scanner -->
        <div class="card mb-4">
            <div class="card-header">
                <h6><i class="fas fa-barcode me-2"></i>Barcode Scanner</h6>
            </div>
            <div class="card-body">
                <div class="text-center">
                    <button type="button" class="btn btn-outline-primary" onclick="startBarcodeScanner()">
                        <i class="fas fa-camera me-1"></i>Scan Barcode
                    </button>
                    <p class="mt-2 text-muted small">
                        Use your device camera to scan product barcode
                    </p>
                </div>
                <div id="barcodeScanner" style="display: none;">
                    <video id="barcodeVideo" width="100%" height="200" autoplay></video>
                </div>
            </div>
        </div>

        <!-- Tips -->
        <div class="card">
            <div class="card-header">
                <h6><i class="fas fa-lightbulb me-2"></i>Tips</h6>
            </div>
            <div class="card-body">
                <ul class="list-unstyled mb-0">
                    <li class="mb-2">
                        <i class="fas fa-check text-success me-2"></i>
                        Use clear, descriptive product names
                    </li>
                    <li class="mb-2">
                        <i class="fas fa-check text-success me-2"></i>
                        Add high-quality product images
                    </li>
                    <li class="mb-2">
                        <i class="fas fa-check text-success me-2"></i>
                        Set appropriate minimum stock levels
                    </li>
                    <li class="mb-0">
                        <i class="fas fa-check text-success me-2"></i>
                        Categorize products for easier management
                    </li>
                </ul>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Live preview functionality
function updatePreview() {
    const name = document.getElementById('name').value || 'Product Name';
    const price = parseFloat(document.getElementById('price').value) || 0;
    const cost = parseFloat(document.getElementById('cost').value) || 0;
    const barcode = document.getElementById('barcode').value || 'Not set';
    const stock = parseInt(document.getElementById('stock_quantity').value) || 0;

    document.getElementById('previewName').textContent = name;
    document.getElementById('previewPrice').textContent = '$' + price.toFixed(2);
    document.getElementById('previewCost').textContent = '(Cost: $' + cost.toFixed(2) + ')';
    document.getElementById('previewBarcode').textContent = 'Barcode: ' + barcode;
    document.getElementById('previewStock').textContent = 'Stock: ' + stock;

    // Calculate margin
    if (price > 0 && cost > 0) {
        const margin = ((price - cost) / price * 100).toFixed(1);
        document.getElementById('previewCost').textContent += ` - Margin: ${margin}%`;
    }
}

// Image preview
document.getElementById('image').addEventListener('change', function(e) {
    const file = e.target.files[0];
    if (file) {
        const reader = new FileReader();
        reader.onload = function(e) {
            document.getElementById('previewImage').innerHTML =
                `<img src="${e.target.result}" style="width: 100%; height: 100%; object-fit: cover; border-radius: 8px;">`;
        };
        reader.readAsDataURL(file);
    }
});

// Add event listeners for live preview
['name', 'price', 'cost', 'barcode', 'stock_quantity'].forEach(field => {
    document.getElementById(field).addEventListener('input', updatePreview);
});

// Generate random barcode
function generateBarcode() {
    const barcode = Math.floor(Math.random() * 9000000000000) + 1000000000000;
    document.getElementById('barcode').value = barcode.toString();
    updatePreview();
}

// Reset form
function resetForm() {
    if (confirm('Are you sure you want to reset the form? All entered data will be lost.')) {
        document.getElementById('productForm').reset();
        document.getElementById('previewImage').innerHTML = '<i class="fas fa-image fa-2x text-muted"></i>';
        updatePreview();
    }
}

// Simple barcode scanner - opens camera for scanning
async function startBarcodeScanner() {
    try {
        // Check if camera is available
        if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
            alert('Camera not supported on this device. Please enter barcode manually or generate one.');
            return;
        }

        // Request camera permission
        const stream = await navigator.mediaDevices.getUserMedia({
            video: { facingMode: { ideal: 'environment' } }
        });

        // Create simple scanner modal
        const scannerModal = document.createElement('div');
        scannerModal.style.cssText = `
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.9);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 10000;
            color: white;
        `;

        scannerModal.innerHTML = `
            <h3 style="margin-bottom: 20px;">Barcode Scanner</h3>
            <video id="scannerVideo" width="300" height="200" autoplay playsinline style="border-radius: 10px;"></video>
            <p style="margin: 20px 0;">Position barcode in camera view</p>
            <button onclick="closeScannerModal()" style="padding: 10px 20px; background: #dc3545; color: white; border: none; border-radius: 5px;">Close Scanner</button>
        `;

        document.body.appendChild(scannerModal);
        const video = document.getElementById('scannerVideo');
        video.srcObject = stream;

        // Store reference for cleanup
        window.currentScannerStream = stream;
        window.currentScannerModal = scannerModal;

        // Simulate barcode detection after 3 seconds (for demo)
        setTimeout(() => {
            const simulatedBarcode = Math.floor(Math.random() * 9000000000000) + 1000000000000;
            document.getElementById('barcode').value = simulatedBarcode.toString();
            updatePreview();
            closeScannerModal();
            alert(`Barcode detected: ${simulatedBarcode}\n(This is a simulated scan - in production, real barcode detection would be used)`);
        }, 3000);

    } catch (error) {
        console.error('Camera access error:', error);
        alert('Camera access denied or not available. Please enter barcode manually or generate one.');
    }
}

// Close scanner modal
function closeScannerModal() {
    if (window.currentScannerStream) {
        window.currentScannerStream.getTracks().forEach(track => track.stop());
        window.currentScannerStream = null;
    }
    if (window.currentScannerModal) {
        document.body.removeChild(window.currentScannerModal);
        window.currentScannerModal = null;
    }
}

// Form validation
document.getElementById('productForm').addEventListener('submit', function(e) {
    const name = document.getElementById('name').value.trim();
    const barcode = document.getElementById('barcode').value.trim();
    const price = parseFloat(document.getElementById('price').value);

    if (!name) {
        alert('Product name is required');
        e.preventDefault();
        return;
    }

    if (!barcode) {
        alert('Barcode is required');
        e.preventDefault();
        return;
    }

    if (!price || price <= 0) {
        alert('Valid selling price is required');
        e.preventDefault();
        return;
    }
});

// Initialize preview on page load
document.addEventListener('DOMContentLoaded', function() {
    updatePreview();
});

// Auto-focus on product name
document.getElementById('name').focus();
</script>
{% endblock %}